<!DOCTYPE html>
<html>
<head>
  <title>Voice Call App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
      background: #f5f5f5;
    }
    .screen { display: none; }
    .active { display: block; }
    .profile-pic {
      width: 120px; height: 120px; border-radius: 50%;
      margin: 20px auto; background: #e9ecef;
      display: flex; align-items: center; justify-content: center;
    }
    button {
      background: #4CAF50; color: white; border: none;
      padding: 12px 20px; border-radius: 4px; font-size: 16px;
      margin: 10px; cursor: pointer; min-width: 160px;
    }
    #end-call { background: #f44336; }
    #mute-btn { background: #FF9800; }
    .status {
      margin: 20px 0; padding: 10px;
      border-radius: 4px; background: #e9ecef;
    }
    .call-code {
      font-size: 24px; font-weight: bold;
      letter-spacing: 3px; color: #2196F3;
      margin: 20px 0;
    }
    input {
      padding: 12px; font-size: 16px;
      width: 180px; text-align: center;
      border: 1px solid #ddd; border-radius: 4px;
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

<!-- Screens -->
<div id="profile-view" class="screen active">
  <div class="profile-pic"><i class="fas fa-user-tie"></i></div>
  <h2>Voice Call App</h2>
  <button id="start-call">Start New Call</button>
  <button id="show-join">Join Existing Call</button>
</div>

<div id="caller-view" class="screen">
  <div class="profile-pic"><i class="fas fa-phone"></i></div>
  <h2>Active Call</h2>
  <div class="status" id="connection-status">Connecting...</div>
  <div class="call-code" id="call-token"></div>
  <p>Share this code with others</p>
  <button id="mute-btn">Mute</button>
  <button id="end-call">End Call</button>
</div>

<div id="join-view" class="screen">
  <div class="profile-pic"><i class="fas fa-phone"></i></div>
  <h2>Join a Call</h2>
  <p>Enter the 6-digit call code:</p>
  <input type="text" id="token-input" maxlength="6" placeholder="123456">
  <button id="join-btn">Join Call</button>
  <p class="status" id="join-status"></p>
</div>

<script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.19.0.js"></script>
<script>
  // Configuration
  const APP_ID = "974f4c7b124940a1a6ee5e526175118d";
  let client = null;
  let localTrack = null;
  let isMuted = false;
  let isConnected = false;

  // DOM Elements
  const elements = {
    profileView: document.getElementById('profile-view'),
    callerView: document.getElementById('caller-view'),
    joinView: document.getElementById('join-view'),
    callTokenDisplay: document.getElementById('call-token'),
    tokenInput: document.getElementById('token-input'),
    joinBtn: document.getElementById('join-btn'),
    joinStatus: document.getElementById('join-status'),
    connectionStatus: document.getElementById('connection-status'),
    startCallBtn: document.getElementById('start-call'),
    showJoinBtn: document.getElementById('show-join'),
    endCallBtn: document.getElementById('end-call'),
    muteBtn: document.getElementById('mute-btn')
  };

  // Helper Functions
  function generateCallCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
  }

  function updateStatus(message, isError = false) {
    const statusElement = isConnected ? elements.connectionStatus : elements.joinStatus;
    statusElement.textContent = message;
    if (isError) statusElement.style.color = '#f44336';
  }

  // Agora Functions
  async function initClient() {
    if (!client) {
      client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
      
      client.on("user-published", async (user, mediaType) => {
        if (mediaType === "audio") {
          await client.subscribe(user, mediaType);
          if (user.uid !== client.uid) {
            user.audioTrack.play();
            updateStatus("Connected to participant");
          }
        }
      });

      client.on("user-unpublished", () => {
        updateStatus("Participant left");
      });
    }
    return client;
  }

  async function joinChannel() {
    if (isConnected) return true;
    
    const urlParams = new URLSearchParams(window.location.search);
    const agoraToken = urlParams.get('agora_token');
    const callCode = urlParams.get('token');

    try {
      await initClient();
      updateStatus("Connecting...");
      
      await client.join(
        APP_ID, 
        "voice-calls",
        agoraToken,
        null
      );
      
      localTrack = await AgoraRTC.createMicrophoneAudioTrack();
      await client.publish([localTrack]);
      
      isConnected = true;
      if (callCode) elements.callTokenDisplay.textContent = callCode;
      updateStatus("Connected to channel");
      return true;
    } catch (err) {
      console.error("Join error:", err);
      updateStatus("Error: " + err.message, true);
      await cleanup();
      return false;
    }
  }

  async function cleanup() {
    try {
      if (localTrack) {
        localTrack.close();
        localTrack = null;
      }
      if (client) {
        await client.leave();
        client = null;
      }
      isConnected = false;
    } catch (err) {
      console.error("Cleanup error:", err);
    }
  }

  // UI Functions
  async function startCall() {
    const callCode = generateCallCode();
    elements.callTokenDisplay.textContent = callCode;
    showScreen("caller-view");
    
    const success = await joinChannel();
    if (!success) {
      showScreen("profile-view");
    }
  }

  async function joinExistingCall() {
    const callCode = elements.tokenInput.value.trim();
    if (!/^\d{6}$/.test(callCode)) {
      updateStatus("Enter a valid 6-digit code", true);
      return;
    }
    
    showScreen("caller-view");
    elements.callTokenDisplay.textContent = callCode;
    
    const success = await joinChannel();
    if (!success) {
      showScreen("join-view");
    }
  }

  async function leaveChannel() {
    await cleanup();
    updateStatus("Call ended");
    showScreen("profile-view");
  }

  function toggleMute() {
    if (localTrack) {
      isMuted = !isMuted;
      localTrack.setMuted(isMuted);
      elements.muteBtn.textContent = isMuted ? "Unmute" : "Mute";
      updateStatus(isMuted ? "You are muted" : "You are unmuted");
    }
  }

  // Event Listeners
  elements.startCallBtn.addEventListener("click", startCall);
  elements.showJoinBtn.addEventListener("click", () => showScreen("join-view"));
  elements.joinBtn.addEventListener("click", joinExistingCall);
  elements.endCallBtn.addEventListener("click", leaveChannel);
  elements.muteBtn.addEventListener("click", toggleMute);

  // Auto-join if token exists
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has("agora_token")) {
    const callCode = urlParams.get("token") || "------";
    elements.callTokenDisplay.textContent = callCode;
    showScreen("caller-view");
    joinChannel();
  }
</script>
</body>
</html>
