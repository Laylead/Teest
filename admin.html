<!-- admin.html -->
<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
</head>
<body>
  <h2>Admin Dashboard</h2>
  <p>Waiting for calls...</p>
  <audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" preload="auto"></audio>

  <script>
    const botToken = "8145304491:AAHz-cm62Ks0q-ask2_X1-G3oJOoL5EwK50";
    const ringtone = document.getElementById("ringtone");
    let lastUpdateId = 0;

    async function getInitialOffset() {
      // Get latest messages to initialize lastUpdateId
      const res = await fetch(`https://api.telegram.org/bot${botToken}/getUpdates`);
      const data = await res.json();
      if (data.ok && data.result.length > 0) {
        lastUpdateId = data.result[data.result.length - 1].update_id;
      }
    }

    async function pollBot() {
      try {
        const res = await fetch(`https://api.telegram.org/bot${botToken}/getUpdates?offset=${lastUpdateId + 1}`);
        const data = await res.json();

        if (data.ok && data.result.length > 0) {
          data.result.forEach(update => {
            lastUpdateId = update.update_id;

            const text = update.message?.text || "";
            const match = text.match(/Channel: (\w+)/);
            if (match) {
              const channelName = match[1];
              notifyCall(channelName);
            }
          });
        }
      } catch (err) {
        console.error("Polling error:", err);
      }

      setTimeout(pollBot, 3000); // Keep polling
    }

    function notifyCall(channelName) {
      if (Notification.permission === "granted") {
        ringtone.loop = true;
        ringtone.play();

        const notification = new Notification("Incoming Call", {
          body: "Click to join",
        });

        notification.onclick = () => {
          ringtone.pause();
          ringtone.currentTime = 0;
          window.open(`call.html?channel=${channelName}&role=admin`, "_blank");
        };
      } else {
        Notification.requestPermission();
      }
    }

    Notification.requestPermission();
    getInitialOffset().then(pollBot);
  </script>
</body>
</html>
