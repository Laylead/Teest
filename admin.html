<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h2 {
      color: #4285f4;
    }
    #callLog {
      margin-top: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      background: #f9f9f9;
    }
    .call-entry {
      padding: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }
    .call-entry:last-child {
      border-bottom: none;
    }
    .join-btn {
      padding: 5px 10px;
      background: #34a853;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .timestamp {
      color: #666;
      font-size: 0.9em;
    }
    .status {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Admin Dashboard</h2>
  <p>You will be notified when a user requests a call</p>
  <div id="callLog">No recent calls</div>
  
  <audio id="ringtone" loop src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    // Telegram configuration
    const BOT_TOKEN = "8145304491:AAHz-cm62Ks0q-ask2_X1-G3oJOoL5EwK50";
    let lastUpdateId = 0;
    
    // DOM elements
    const callLog = document.getElementById("callLog");
    const ringtone = document.getElementById("ringtone");
    
    // Call polling function
    async function pollForCalls() {
      try {
        const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}`);
        const data = await response.json();
        
        if (data.ok && data.result.length > 0) {
          data.result.forEach(update => {
            lastUpdateId = update.update_id;
            const messageText = update.message?.text || "";
            
            // Check if message contains call information
            if (messageText.includes("New Call Request") && messageText.includes("Channel:")) {
              const channelMatch = messageText.match(/Channel: (\w+)/);
              if (channelMatch) {
                const channelName = channelMatch[1];
                addCallToLog(channelName);
                notifyAdmin(channelName);
              }
            }
          });
        }
      } catch (error) {
        console.error("Error polling for calls:", error);
      }
      
      // Poll every 3 seconds
      setTimeout(pollForCalls, 3000);
    }
    
    // Add call to the log
    function addCallToLog(channelName) {
      if (callLog.textContent === "No recent calls") {
        callLog.textContent = "";
      }
      
      const callEntry = document.createElement("div");
      callEntry.className = "call-entry";
      
      const callInfo = document.createElement("div");
      callInfo.innerHTML = `
        <div class="status">New call request</div>
        <div>Channel: ${channelName}</div>
        <div class="timestamp">${new Date().toLocaleTimeString()}</div>
      `;
      
      const joinButton = document.createElement("button");
      joinButton.className = "join-btn";
      joinButton.textContent = "Join Call";
      joinButton.onclick = () => {
        ringtone.pause();
        window.open(`call.html?channel=${channelName}&role=admin`, "_blank");
      };
      
      callEntry.appendChild(callInfo);
      callEntry.appendChild(joinButton);
      callLog.prepend(callEntry);
    }
    
    // Notify admin with sound and notification
    function notifyAdmin(channelName) {
      // Play ringtone
      ringtone.play().catch(e => console.error("Could not play ringtone:", e));
      
      // Show browser notification
      if (Notification.permission === "granted") {
        const notification = new Notification("New Call Request", {
          body: `Channel: ${channelName}`,
          icon: "https://cdn-icons-png.flaticon.com/512/3059/3059518.png"
        });
        
        notification.onclick = () => {
          window.open(`call.html?channel=${channelName}&role=admin`, "_blank");
        };
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then(permission => {
          if (permission === "granted") notifyAdmin(channelName);
        });
      }
    }
    
    // Initialize
    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    
    // Start polling for calls
    pollForCalls();
  </script>
</body>
</html>
